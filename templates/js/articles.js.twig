
<script>




class Article {
    constructor(id, qty, image, nom, prix, stock) {
        this.id = id;
        this.qty = qty;
        this.image = image;
        this.nom = nom;
        this.prix = prix;
        this.stock = stock;
    }
}

//localStorage.clear();
function lesPaniers(){
    var paniers = document.querySelectorAll('.panier');
    paniers.forEach(panier => {
        panier.addEventListener('click', function() {
            let id = this.dataset.id;
            let qty = document.querySelector('#artId'+ id).value;
            let image = this.dataset.image;
            let nom = this.dataset.nom;
            let prix = this.dataset.prix;
            let stock = this.dataset.stock;
            var articleObj = new Article(id, qty, image, nom, prix, stock);
            
            if(localStorage.getItem('paniers')){
                let articleLocal= JSON.parse(localStorage.getItem('paniers'));
                let flag = true;
                articleLocal.forEach((article, index, object) => {
                    if (articleObj.qty == 0 & articleObj.id == article.id){
                        object.splice(index, 1);
                        tostArticles(articleObj, 'zero');
                        flag = false;
                    }else{
                        if(articleObj.id == article.id){
                            article.qty = qty;
                            tostArticles(articleObj, 'ajout');
                            flag = false;
                        }
                    }
                });
                if(flag){
                    if(articleObj.qty == 0){
                        tostArticles(articleObj, 'erreur');
                    }else{
                        articleLocal.push(articleObj);
                        tostArticles(articleObj, 'ajout');  
                    }
                }
                localStorage.removeItem('paniers');
                localStorage.setItem("paniers",JSON.stringify(articleLocal));
                gestionPanier();
            }else{
                if(articleObj.qty == 0){
                    tostArticles(articleObj, 'erreur');
                }else{
                    var articleLocal = [];
                    articleLocal.push(articleObj);
                    tostArticles(articleObj, 'ajout');
                    localStorage.setItem("paniers",JSON.stringify(articleLocal));
                    gestionPanier();
                }
                
            }
            
        });
    });
}
lesPaniers();

console.log(localStorage.getItem('paniers'));

majInputPanier();

var recherche = document.querySelector('#recherche');
var gomme = document.querySelector('.gomme');
var affichageArticles = document.querySelector('.affichageArticles');

gomme.addEventListener('click', function(){
  recherche.value = "";
  document.location.reload();
});

 recherche.addEventListener('keyup', async function (e) {
    event.preventDefault();
    if(recherche.value == ''){
        gomme.classList.add('hidden');
        document.location.reload();
    }else{
        gomme.classList.remove('hidden');
    }
    if(recherche.value.length > 2){
        var data = new FormData();
        data.append( 'mot' , recherche.value);
        let response = await fetch('{{ path('recherche_articles') }}', {
        method: 'POST',
        headers: {
          'X-Requested-With': 'xmlhttprequest'
        },
        body : data
        })
        let responseData = await response.json();
        if (response.ok === true & responseData.success) {
            affichageArticles.innerHTML = responseData.html;
            
            lesPaniers();
            majInputPanier();

        }
    }

});


</script>